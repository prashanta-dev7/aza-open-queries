<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Aza — Open Queries (WhatsApp)</title>
  <style>
    :root{--bg:#f7f7f8;--card:#fff;--text:#111827;--muted:#6b7280;--border:#e5e7eb;--brand:#b60e2a;--ok:#1f6f37;--warn:#7a5b00;--breach:#8a1c1c;--table-head:#fafafa;--radius:14px;--shadow:0 6px 20px rgba(17,24,39,.06)}
    *{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--text);font:15px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .container{max-width:1100px;margin:0 auto;padding:24px}
    header{margin-bottom:18px}h1{font-size:20px;margin:0}.brand-dot{width:12px;height:12px;border-radius:50%;background:var(--brand);display:inline-block;margin-right:8px}
    .muted{color:var(--muted)}.row{display:grid;grid-template-columns:1.2fr .8fr;gap:16px}
    @media(max-width:820px){.row{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow)}.card-body{padding:16px}.card-title{font-weight:600;margin:0 0 10px}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input[type=file],input[type=date],input[type=number]{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff;outline:none}
    .btn{appearance:none;border:0;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer}.btn-primary{background:var(--brand);color:#fff}.btn-secondary{background:#fff;border:1px solid var(--border)}
    .toolbar{display:flex;gap:8px;align-items:center;margin-top:8px}
    .table-wrap{border:1px solid var(--border);border-radius:12px;overflow:hidden;background:#fff}
    table{width:100%;border-collapse:collapse;font-size:13px}thead th{background:var(--table-head);position:sticky;top:0}
    th,td{padding:10px 12px;border-bottom:1px solid var(--border);text-align:left;vertical-align:top}tbody tr:hover{background:#fafafa}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;font-weight:600}
    .pill-open{background:#fff3cd;color:var(--warn)}.pill-breach{background:#fde2e1;color:var(--breach)}.pill-closed{background:#e7f5e8;color:var(--ok)}
    .stats{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:12px}.stat{padding:12px;border:1px solid var(--border);border-radius:12px;background:#fff}
    .stat .k{font-size:20px;font-weight:800}.stat .l{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1><span class="brand-dot"></span>Aza — Open Queries (MVP)</h1>
      <div class="muted" style="margin-top:4px">Upload WhatsApp <span class="mono">.txt</span> and Mapping <span class="mono">.csv</span>. No DB.</div>
    </header>

    <div class="card" style="margin-bottom:12px">
      <div class="card-body">
        <div class="row">
          <div>
            <label for="chat">WhatsApp chat export (.txt)</label>
            <input type="file" id="chat" accept=".txt" required />
            <div class="muted" style="font-size:12px;margin-top:6px">Android/iOS exports supported.</div>
          </div>
          <div>
            <label for="mapping">PID → Designer → Merch mapping (.csv)</label>
            <input type="file" id="mapping" accept=".csv" required />
            <div class="muted" style="font-size:12px;margin-top:6px">Headers: <span class="mono">productID, designerName, merchandiserName</span>.</div>
          </div>
          <div class="row" style="gap:12px">
            <div>
              <label for="cutoff">Cutoff date (IST)</label>
              <input type="date" id="cutoff" required />
              <div class="muted" style="font-size:12px;margin-top:6px">Default: 2025-09-10</div>
            </div>
            <div>
              <label for="sla">SLA (minutes)</label>
              <input type="number" id="sla" min="1" step="1" value="60" required />
            </div>
          </div>
        </div>

        <div class="toolbar">
          <button id="processBtn" class="btn btn-primary">Process</button>
          <button id="downloadCsvBtn" class="btn btn-secondary" disabled>Download CSV</button>
          <span id="status" class="muted"></span>
        </div>

        <div class="stats">
          <div class="stat"><div class="k" id="statTotal">0</div><div class="l">Total</div></div>
          <div class="stat"><div class="k" id="statOpen">0</div><div class="l">Open</div></div>
          <div class="stat"><div class="k" id="statBreached">0</div><div class="l">Breached</div></div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-body">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
          <div class="card-title">Results</div>
          <div id="summary" class="muted" style="font-size:13px"></div>
        </div>
        <div class="table-wrap" style="max-height:65vh;overflow:auto">
          <table>
            <thead>
              <tr>
                <th>PID</th>
                <th>Designer</th>
                <th>Assigned Merch</th>
                <th>Status</th>
                <th>First CS Message</th>
                <th>First CS Time</th>
                <th>Latest CS Message</th>
                <th>CS Time</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    const cutoffInput = document.getElementById('cutoff'); cutoffInput.value = '2025-09-10';
    const processBtn = document.getElementById('processBtn');
    const downloadBtn = document.getElementById('downloadCsvBtn');
    const statusSpan = document.getElementById('status');
    const tbody = document.getElementById('tbody');
    const summarySpan = document.getElementById('summary');
    const statTotal = document.getElementById('statTotal');
    const statOpen = document.getElementById('statOpen');
    const statBreached = document.getElementById('statBreached');
    let lastCsvBlobUrl = null;

    processBtn.addEventListener('click', async () => {
      const chatFile = document.getElementById('chat').files[0];
      const mapFile  = document.getElementById('mapping').files[0];
      if (!chatFile || !mapFile) { alert('Please choose both files'); return; }

      processBtn.disabled = true; downloadBtn.disabled = true;
      statusSpan.textContent = 'Processing…';

      try {
        const [chatText, mappingCsvText] = await Promise.all([chatFile.text(), mapFile.text()]);
        const cutoffDate = document.getElementById('cutoff').value || '2025-09-10';
        const slaMinutes = parseInt(document.getElementById('sla').value || '60', 10);

        const res = await fetch('/api/backend', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ chatText, mappingCsvText, cutoffDate, slaMinutes })
        });
        if (!res.ok) throw new Error(await res.text());
        const { rows, csv, meta } = await res.json();

        const total = rows?.length || 0;
        const openCount = rows.filter(r => (r.status||'').toLowerCase().startsWith('open')).length;
        const breachedCount = rows.filter(r => (r.status||'').toLowerCase().includes('breach')).length;
        statTotal.textContent = total; statOpen.textContent = openCount; statBreached.textContent = breachedCount;

        summarySpan.textContent = `Cutoff: ${cutoffDate} • SLA: ${slaMinutes} min • Mapping: ${meta?.mappingCount ?? 0} PIDs • Matched: ${meta?.matchedPidCount ?? 0}`;

        tbody.innerHTML = '';
        for (const r of rows) {
          const tr = document.createElement('tr');
          const pillClass = r.status?.toLowerCase().includes('breach') ? 'pill-breach'
                           : r.status?.toLowerCase().startsWith('open') ? 'pill-open'
                           : 'pill-closed';
          tr.innerHTML = `
            <td class="mono">${esc(r.pid)}</td>
            <td>${esc(r.designer || '')}</td>
            <td>${esc(r.assigned_merch || '')}</td>
            <td><span class="pill ${pillClass}">${esc(r.status || '')}</span></td>
            <td>${esc(r.first_cs_preview || '')}</td>
            <td class="mono">${esc(r.first_cs_ts_ist || '')}</td>
            <td>${esc(r.latest_cs_preview || '')}</td>
            <td class="mono">${esc(r.cs_ts_ist || '')}</td>
          `;
          tbody.appendChild(tr);
        }

        if (lastCsvBlobUrl) URL.revokeObjectURL(lastCsvBlobUrl);
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
        lastCsvBlobUrl = URL.createObjectURL(blob);
        downloadBtn.disabled = false;
        downloadBtn.onclick = () => {
          const a = document.createElement('a');
          a.href = lastCsvBlobUrl;
          a.download = `open_queries_${new Date().toISOString().slice(0,10)}.csv`;
          document.body.appendChild(a); a.click(); document.body.removeChild(a);
        };

        statusSpan.textContent = 'Done';
      } catch (err) {
        console.error(err);
        alert('Error: ' + err.message);
        statusSpan.textContent = 'Error';
      } finally {
        processBtn.disabled = false;
      }
    });

    function esc(s){ return (s ?? '').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;'); }
  </script>
</body>
</html>
